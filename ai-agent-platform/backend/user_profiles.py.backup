"""
User Profile System - Personalization & Context Memory
"""

from typing import Dict, Any, Optional, List
from datetime import datetime
import json
import os
import sqlite3
from contextlib import contextmanager
# from loguru import logger

class UserProfileManager:
    """
    Manages user profiles, preferences, and context with SQLite persistence
    """
    
    def __init__(self, db_path: str = "data/user_profiles.db"):
        self.db_path = db_path
        os.makedirs(os.path.dirname(db_path), exist_ok=True)
        self.init_db()
    
    @contextmanager
    def get_db_connection(self):
        """Get database connection"""
        conn = sqlite3.connect(self.db_path)
        conn.row_factory = sqlite3.Row
        try:
            yield conn
        finally:
            conn.close()
    
    def init_db(self):
        """Initialize database tables"""
        with self.get_db_connection() as conn:
            # Users table
            conn.execute('''
                CREATE TABLE IF NOT EXISTS users (
                    user_id TEXT PRIMARY KEY,
                    email TEXT UNIQUE,
                    profile_data TEXT NOT NULL,
                    created_at TEXT NOT NULL,
                    updated_at TEXT NOT NULL
                )
            ''')

            # Job applications table
            conn.execute('''
                CREATE TABLE IF NOT EXISTS job_applications (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    user_id TEXT NOT NULL,
                    job_title TEXT NOT NULL,
                    company TEXT NOT NULL,
                    job_url TEXT NOT NULL,
                    platform TEXT NOT NULL,
                    status TEXT NOT NULL,
                    applied_at TEXT NOT NULL,
                    response TEXT,
                    notes TEXT,
                    FOREIGN KEY (user_id) REFERENCES users (user_id)
                )
            ''')

            # User activity table
            conn.execute('''
                CREATE TABLE IF NOT EXISTS user_activity (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    user_id TEXT NOT NULL,
                    action TEXT NOT NULL,
                    details TEXT,
                    timestamp TEXT NOT NULL,
                    FOREIGN KEY (user_id) REFERENCES users (user_id)
                )
            ''')

            # Task history table
            conn.execute('''
                CREATE TABLE IF NOT EXISTS task_history (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    user_id TEXT NOT NULL,
                    task_type TEXT NOT NULL,
                    query TEXT NOT NULL,
                    agent_used TEXT NOT NULL,
                    success BOOLEAN NOT NULL,
                    response_time REAL,
                    error_message TEXT,
                    created_at TEXT NOT NULL,
                    FOREIGN KEY (user_id) REFERENCES users (user_id)
                )
            ''')

    def save_job_application(self, user_id: str, application_data: Dict[str, Any]) -> int:
        """Save job application to database"""
        with self.get_db_connection() as conn:
            cursor = conn.execute('''
                INSERT INTO job_applications
                (user_id, job_title, company, job_url, platform, status, applied_at, response, notes)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
            ''', (
                user_id,
                application_data['job_title'],
                application_data['company'],
                application_data['job_url'],
                application_data.get('platform', 'unknown'),
                application_data['status'],
                application_data.get('applied_at', datetime.now(timezone.utc).isoformat()),
                application_data.get('response', ''),
                application_data.get('notes', '')
            ))
            conn.commit()
            return cursor.lastrowid

    def get_job_applications(self, user_id: str, limit: int = 50) -> List[Dict[str, Any]]:
        """Get user's job applications"""
        with self.get_db_connection() as conn:
            rows = conn.execute('''
                SELECT * FROM job_applications
                WHERE user_id = ?
                ORDER BY applied_at DESC
                LIMIT ?
            ''', (user_id, limit)).fetchall()

            return [dict(row) for row in rows]

    def log_user_activity(self, user_id: str, action: str, details: Dict[str, Any] = None) -> None:
        """Log user activity"""
        with self.get_db_connection() as conn:
            conn.execute('''
                INSERT INTO user_activity (user_id, action, details, timestamp)
                VALUES (?, ?, ?, ?)
            ''', (
                user_id,
                action,
                json.dumps(details) if details else None,
                datetime.now(timezone.utc).isoformat()
            ))
            conn.commit()

    def log_task_execution(self, user_id: str, task_type: str, query: str, agent_used: str,
                          success: bool, response_time: float = None, error_message: str = None) -> None:
        """Log task execution"""
        with self.get_db_connection() as conn:
            conn.execute('''
                INSERT INTO task_history
                (user_id, task_type, query, agent_used, success, response_time, error_message, created_at)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?)
            ''', (
                user_id,
                task_type,
                query,
                agent_used,
                success,
                response_time,
                error_message,
                datetime.now(timezone.utc).isoformat()
            ))
            conn.commit()

    def get_user_stats(self, user_id: str) -> Dict[str, Any]:
        """Get comprehensive user statistics"""
        with self.get_db_connection() as conn:
            # Task statistics
            task_stats = conn.execute('''
                SELECT
                    COUNT(*) as total_tasks,
                    SUM(CASE WHEN success = 1 THEN 1 ELSE 0 END) as successful_tasks,
                    AVG(response_time) as avg_response_time,
                    COUNT(DISTINCT agent_used) as agents_used
                FROM task_history
                WHERE user_id = ? AND created_at >= date('now', '-30 days')
            ''', (user_id,)).fetchone()

            # Job application statistics
            job_stats = conn.execute('''
                SELECT
                    COUNT(*) as total_applications,
                    SUM(CASE WHEN status = 'applied' THEN 1 ELSE 0 END) as successful_applications
                FROM job_applications
                WHERE user_id = ? AND applied_at >= date('now', '-30 days')
            ''', (user_id,)).fetchone()

            return {
                'task_stats': dict(task_stats) if task_stats else {},
                'job_stats': dict(job_stats) if job_stats else {},
                'last_activity': self.get_last_activity(user_id)
            }

    def get_last_activity(self, user_id: str) -> Optional[str]:
        """Get user's last activity timestamp"""
        with self.get_db_connection() as conn:
            row = conn.execute('''
                SELECT timestamp FROM user_activity
                WHERE user_id = ?
                ORDER BY timestamp DESC
                LIMIT 1
            ''', (user_id,)).fetchone()

            return row['timestamp'] if row else None

    def create_profile(self, user_id: str, profile_data: Dict[str, Any]) -> Dict[str, Any]:
        """Create new user profile"""
        
        profile = {
            "user_id": user_id,
            "created_at": datetime.now(timezone.utc).isoformat(),
            "updated_at": datetime.now(timezone.utc).isoformat(),
            "personal_info": {
                "first_name": profile_data.get("first_name", ""),
                "last_name": profile_data.get("last_name", ""),
                "email": profile_data.get("email", ""),
                "phone": profile_data.get("phone", "")
            },
            "professional": {
                "title": profile_data.get("job_title", ""),
                "skills": profile_data.get("skills", []),
                "experience_years": profile_data.get("experience_years", 0),
                "preferred_locations": profile_data.get("preferred_locations", []),
                "salary_expectation": profile_data.get("salary_expectation", 0)
            },
            "preferences": {
                "search_language": "en",
                "timezone": "UTC",
                "notification_settings": {
                    "email": True,
                    "push": False
                }
            },
            "context": {
                "recent_queries": [],
                "favorite_searches": [],
                "subscription": profile_data.get("subscription", "free"),
                "task_count": 0,
                "last_activity": datetime.now(timezone.utc).isoformat()
            }
        }
        
        with self.get_db_connection() as conn:
            conn.execute(
                'INSERT OR REPLACE INTO users (user_id, profile_data, created_at, updated_at) VALUES (?, ?, ?, ?)',
                (user_id, json.dumps(profile), profile["created_at"], profile["updated_at"])
            )
            conn.commit()
        
        return profile
    
    def get_profile(self, user_id: str) -> Optional[Dict[str, Any]]:
        """Load user profile from database"""
        with self.get_db_connection() as conn:
            row = conn.execute('SELECT profile_data FROM users WHERE user_id = ?', (user_id,)).fetchone()
            if row:
                return json.loads(row['profile_data'])
        return None
    
    def update_user(self, user_id: str, updates: Dict[str, Any]):
        """Update user profile"""
        profile = self.get_profile(user_id)
        if not profile:
            profile = self.create_profile(user_id, updates)
            return
        
        # Update profile data
        for key, value in updates.items():
            if key in profile:
                if isinstance(profile[key], dict) and isinstance(value, dict):
                    profile[key].update(value)
                else:
                    profile[key] = value
            else:
                profile[key] = value
        
        profile['updated_at'] = datetime.now(timezone.utc).isoformat()
        
        with self.get_db_connection() as conn:
            conn.execute(
                'UPDATE users SET profile_data = ?, updated_at = ? WHERE user_id = ?',
                (json.dumps(profile), profile['updated_at'], user_id)
            )
            conn.commit()
    
    def update_context(self, user_id: str, query: str, result: Any):
        """Update user context with new query"""
        profile = self.get_profile(user_id)
        
        if profile:
            # Add to recent queries
            profile['context']['recent_queries'].insert(0, {
                "query": query,
                "timestamp": datetime.now(timezone.utc).isoformat(),
                "success": result.get('status') == 'success'
            })
            
            # Keep only last 50 queries
            profile['context']['recent_queries'] = profile['context']['recent_queries'][:50]
            
            # Update statistics
            profile['statistics']['total_queries'] += 1
            if result.get('status') == 'success':
                profile['statistics']['successful_tasks'] += 1
            else:
                profile['statistics']['failed_tasks'] += 1
            
            self.save_profile(user_id, profile)
    
    def get_personalized_context(self, user_id: str) -> Dict[str, Any]:
        """Get context for personalized responses"""
        profile = self.get_profile(user_id)
        
        if not profile:
            return {}
        
        return {
            "user_skills": profile['professional']['skills'],
            "location": profile['personal_info']['location'],
            "recent_interests": [q['query'] for q in profile['context']['recent_queries'][:5]],
            "preferences": profile['preferences']
        }

# Global instance
profile_manager = UserProfileManager()        #   R e s u m e   M a n a g e m e n t   M e t h o d s 
         d e f   u p d a t e _ r e s u m e _ d a t a ( s e l f ,   u s e r _ i d :   s t r ,   r e s u m e _ d a t a :   D i c t [ s t r ,   A n y ] )   - >   b o o l : 
                 " " " U p d a t e   r e s u m e - r e l a t e d   d a t a   i n   u s e r   p r o f i l e " " " 
                 t r y : 
                         p r o f i l e   =   s e l f . g e t _ p r o f i l e ( u s e r _ i d ) 
                         i f   n o t   p r o f i l e : 
                                 r e t u r n   F a l s e 
 
                         #   I n i t i a l i z e   r e s u m e   d a t a   i f   n o t   e x i s t s 
                         i f   " r e s u m e "   n o t   i n   p r o f i l e : 
                                 p r o f i l e [ " r e s u m e " ]   =   { 
                                         " a c t i v e _ r e s u m e _ i d " :   N o n e , 
                                         " a t s _ s c o r e s " :   { } , 
                                         " a n a l y t i c s " :   { } , 
                                         " t e m p l a t e s " :   [ ] , 
                                         " l a s t _ u p d a t e d " :   N o n e 
                                 } 
 
                         #   U p d a t e   r e s u m e   d a t a 
                         p r o f i l e [ " r e s u m e " ] . u p d a t e ( r e s u m e _ d a t a ) 
                         p r o f i l e [ " r e s u m e " ] [ " l a s t _ u p d a t e d " ]   =   d a t e t i m e . n o w ( ) . i s o f o r m a t ( ) 
 
                         s e l f . s a v e _ p r o f i l e ( u s e r _ i d ,   p r o f i l e ) 
                         r e t u r n   T r u e 
 
                 e x c e p t   E x c e p t i o n   a s   e : 
                         p r i n t ( f " F a i l e d   t o   u p d a t e   r e s u m e   d a t a   f o r   u s e r   { u s e r _ i d } :   { e } " ) 
                         r e t u r n   F a l s e 
 
         d e f   g e t _ a c t i v e _ r e s u m e _ i d ( s e l f ,   u s e r _ i d :   s t r )   - >   O p t i o n a l [ s t r ] : 
                 " " " G e t   t h e   a c t i v e   r e s u m e   I D   f o r   a   u s e r " " " 
                 p r o f i l e   =   s e l f . g e t _ p r o f i l e ( u s e r _ i d ) 
                 i f   p r o f i l e   a n d   " r e s u m e "   i n   p r o f i l e : 
                         r e t u r n   p r o f i l e [ " r e s u m e " ] . g e t ( " a c t i v e _ r e s u m e _ i d " ) 
                 r e t u r n   N o n e 
 
         d e f   s e t _ a c t i v e _ r e s u m e ( s e l f ,   u s e r _ i d :   s t r ,   r e s u m e _ i d :   s t r )   - >   b o o l : 
                 " " " S e t   t h e   a c t i v e   r e s u m e   f o r   a   u s e r " " " 
                 r e t u r n   s e l f . u p d a t e _ r e s u m e _ d a t a ( u s e r _ i d ,   { " a c t i v e _ r e s u m e _ i d " :   r e s u m e _ i d } ) 
 
         d e f   a d d _ r e s u m e _ t e m p l a t e ( s e l f ,   u s e r _ i d :   s t r ,   t e m p l a t e _ d a t a :   D i c t [ s t r ,   A n y ] )   - >   b o o l : 
                 " " " A d d   a   r e s u m e   t e m p l a t e   t o   u s e r  
 '  
 s   c o l l e c t i o n " " " 
                 t r y : 
                         p r o f i l e   =   s e l f . g e t _ p r o f i l e ( u s e r _ i d ) 
                         i f   n o t   p r o f i l e : 
                                 r e t u r n   F a l s e 
 
                         i f   " r e s u m e "   n o t   i n   p r o f i l e : 
                                 p r o f i l e [ " r e s u m e " ]   =   { 
                                         " a c t i v e _ r e s u m e _ i d " :   N o n e , 
                                         " a t s _ s c o r e s " :   { } , 
                                         " a n a l y t i c s " :   { } , 
                                         " t e m p l a t e s " :   [ ] , 
                                         " l a s t _ u p d a t e d " :   N o n e 
                                 } 
 
                         p r o f i l e [ " r e s u m e " ] [ " t e m p l a t e s " ] . a p p e n d ( { 
                                 " i d " :   t e m p l a t e _ d a t a . g e t ( " i d " ) , 
                                 " n a m e " :   t e m p l a t e _ d a t a . g e t ( " n a m e " ) , 
                                 " c r e a t e d _ a t " :   d a t e t i m e . n o w ( ) . i s o f o r m a t ( ) , 
                                 " d a t a " :   t e m p l a t e _ d a t a 
                         } ) 
 
                         s e l f . s a v e _ p r o f i l e ( u s e r _ i d ,   p r o f i l e ) 
                         r e t u r n   T r u e 
 
                 e x c e p t   E x c e p t i o n   a s   e : 
                         p r i n t ( f " F a i l e d   t o   a d d   r e s u m e   t e m p l a t e   f o r   u s e r   { u s e r _ i d } :   { e } " ) 
                         r e t u r n   F a l s e 
 
         d e f   u p d a t e _ a t s _ s c o r e ( s e l f ,   u s e r _ i d :   s t r ,   j o b _ i d :   s t r ,   s c o r e :   f l o a t ,   d e t a i l s :   D i c t [ s t r ,   A n y ] )   - >   b o o l : 
                 " " " U p d a t e   A T S   s c o r e   f o r   a   s p e c i f i c   j o b " " " 
                 t r y : 
                         p r o f i l e   =   s e l f . g e t _ p r o f i l e ( u s e r _ i d ) 
                         i f   n o t   p r o f i l e   o r   " r e s u m e "   n o t   i n   p r o f i l e : 
                                 r e t u r n   F a l s e 
 
                         p r o f i l e [ " r e s u m e " ] [ " a t s _ s c o r e s " ] [ j o b _ i d ]   =   { 
                                 " s c o r e " :   s c o r e , 
                                 " d e t a i l s " :   d e t a i l s , 
                                 " t i m e s t a m p " :   d a t e t i m e . n o w ( ) . i s o f o r m a t ( ) 
                         } 
 
                         s e l f . s a v e _ p r o f i l e ( u s e r _ i d ,   p r o f i l e ) 
                         r e t u r n   T r u e 
 
                 e x c e p t   E x c e p t i o n   a s   e : 
                         p r i n t ( f " F a i l e d   t o   u p d a t e   A T S   s c o r e   f o r   u s e r   { u s e r _ i d } :   { e } " ) 
                         r e t u r n   F a l s e 
 
         d e f   g e t _ r e s u m e _ a n a l y t i c s ( s e l f ,   u s e r _ i d :   s t r )   - >   D i c t [ s t r ,   A n y ] : 
                 " " " G e t   r e s u m e   a n a l y t i c s   d a t a " " " 
                 p r o f i l e   =   s e l f . g e t _ p r o f i l e ( u s e r _ i d ) 
                 i f   p r o f i l e   a n d   " r e s u m e "   i n   p r o f i l e : 
                         r e t u r n   p r o f i l e [ " r e s u m e " ] . g e t ( " a n a l y t i c s " ,   { } ) 
                 r e t u r n   { } 
 
         d e f   u p d a t e _ r e s u m e _ a n a l y t i c s ( s e l f ,   u s e r _ i d :   s t r ,   a n a l y t i c s _ d a t a :   D i c t [ s t r ,   A n y ] )   - >   b o o l : 
                 " " " U p d a t e   r e s u m e   a n a l y t i c s " " " 
                 t r y : 
                         p r o f i l e   =   s e l f . g e t _ p r o f i l e ( u s e r _ i d ) 
                         i f   n o t   p r o f i l e : 
                                 r e t u r n   F a l s e 
 
                         i f   " r e s u m e "   n o t   i n   p r o f i l e : 
                                 p r o f i l e [ " r e s u m e " ]   =   { 
                                         " a c t i v e _ r e s u m e _ i d " :   N o n e , 
                                         " a t s _ s c o r e s " :   { } , 
                                         " a n a l y t i c s " :   { } , 
                                         " t e m p l a t e s " :   [ ] , 
                                         " l a s t _ u p d a t e d " :   N o n e 
                                 } 
 
                         p r o f i l e [ " r e s u m e " ] [ " a n a l y t i c s " ] . u p d a t e ( a n a l y t i c s _ d a t a ) 
                         p r o f i l e [ " r e s u m e " ] [ " l a s t _ u p d a t e d " ]   =   d a t e t i m e . n o w ( ) . i s o f o r m a t ( ) 
 
                         s e l f . s a v e _ p r o f i l e ( u s e r _ i d ,   p r o f i l e ) 
                         r e t u r n   T r u e 
 
                 e x c e p t   E x c e p t i o n   a s   e : 
                         p r i n t ( f " F a i l e d   t o   u p d a t e   r e s u m e   a n a l y t i c s   f o r   u s e r   { u s e r _ i d } :   { e } " ) 
                         r e t u r n   F a l s e 
 
 #   G l o b a l   i n s t a n c e 
 p r o f i l e _ m a n a g e r   =   U s e r P r o f i l e M a n a g e r ( )  
 